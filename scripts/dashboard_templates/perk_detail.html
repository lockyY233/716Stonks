<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Perk {{ perk_id }} · 716Stonks</title>
  <style>
    :root { --bg:#0f172a; --line:#1f2937; --text:#e5e7eb; --muted:#94a3b8; --btn:#334155; --btnH:#475569; }
    body { margin:0; background:var(--bg); color:var(--text); font-family:ui-sans-serif, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; }
    .wrap { max-width: 1100px; margin: 20px auto; padding: 0 14px; display:grid; grid-template-columns: 1fr; gap: 12px; }
    .card { background: linear-gradient(180deg,#0b1220,#0a101c); border: 1px solid var(--line); border-radius: 12px; padding: 12px; }
    .top { display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; }
    .title { font-size:1.2rem; font-weight:700; }
    .row { display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:8px; }
    .row.one { grid-template-columns:1fr; }
    label { display:block; font-size:.82rem; color:var(--muted); margin-bottom:4px; }
    input, textarea, select { width:100%; padding:8px; border-radius:8px; border:1px solid #334155; background:#0b1323; color:var(--text); }
    textarea { min-height: 86px; resize: vertical; }
    button { padding:8px 11px; border:1px solid #334155; border-radius:8px; background:var(--btn); color:var(--text); cursor:pointer; }
    button:hover { background: var(--btnH); }
    table { width:100%; border-collapse: collapse; }
    th, td { border-bottom: 1px solid #1f2937; padding: 7px 6px; text-align: left; }
    th { color: var(--muted); font-size:.84rem; }
    .muted { color:var(--muted); font-size:.85rem; }
    a { color:#7dd3fc; text-decoration:none; font-size:.9rem; }
    @media (max-width: 760px) {
      .row { grid-template-columns: 1fr; }
      .top { flex-direction: column; align-items: flex-start; gap: 6px; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="top">
        <div class="title">Perk Editor · #{{ perk_id }}</div>
        <a id="backLink" href="/">Back to Dashboard</a>
      </div>
      <div class="row">
        <div><label>Name</label><input id="name" /></div>
        <div><label>Priority</label><input id="priority" type="number" step="1" /></div>
      </div>
      <div class="row">
        <div><label>Enabled (1/0)</label><input id="enabled" type="number" step="1" min="0" max="1" /></div>
        <div><label>Stack Mode</label><select id="stack_mode"><option value="add">add</option><option value="override">override</option><option value="max_only">max_only</option></select></div>
      </div>
      <div class="row">
        <div><label>Max Stacks</label><input id="max_stacks" type="number" step="1" min="1" /></div>
        <div></div>
      </div>
      <div class="row one">
        <div><label>Description</label><textarea id="description"></textarea></div>
      </div>
      <button id="savePerkBtn">Save Perk</button>
      <button id="deletePerkBtn" style="margin-left:8px;background:#7f1d1d;border-color:#ef4444;color:#fee2e2;">Delete Perk</button>
      <div id="msg" class="muted" style="margin-top:8px;"></div>
    </div>

    <div class="card">
      <div class="top"><div class="title">Requirements</div></div>
      <table>
        <thead><tr><th>ID</th><th>Group</th><th>Type</th><th>Commodity</th><th>Op</th><th>Value</th><th>Action</th></tr></thead>
        <tbody id="reqRows"><tr><td colspan="7" class="muted">Loading...</td></tr></tbody>
      </table>
      <div class="row" style="margin-top:10px;">
        <div><label>Group</label><input id="new_req_group" type="number" step="1" value="1" /></div>
        <div><label>Type</label><select id="new_req_type"><option value="commodity_qty">commodity_qty</option><option value="tag_qty">tag_qty</option><option value="any_single_commodity_qty">any_single_commodity_qty</option></select></div>
      </div>
      <div class="row">
        <div><label>Commodity Name</label><select id="new_req_commodity"></select></div>
        <div><label>Operator</label><select id="new_req_operator"><option>>=</option><option>></option><option><=</option><option><</option><option>==</option><option>!=</option></select></div>
      </div>
      <div class="row">
        <div><label>Value (quantity)</label><input id="new_req_value" type="number" step="1" min="0" value="1" /></div>
        <div><button id="addReqBtn" style="margin-top:25px;">+ Add Requirement</button></div>
      </div>
    </div>

    <div class="card">
      <div class="top"><div class="title">Effects</div></div>
      <table>
        <thead><tr><th>ID</th><th>Target</th><th>Mode</th><th>Value</th><th>Scale Src</th><th>Scale Key</th><th>Scale Factor</th><th>Cap</th><th>Action</th></tr></thead>
        <tbody id="effectRows"><tr><td colspan="9" class="muted">Loading...</td></tr></tbody>
      </table>
      <div class="row" style="margin-top:10px;">
        <div><label>Target Stat</label><select id="new_eff_target"><option value="income">income</option><option value="trade_limits">trade_limits</option><option value="networth">networth</option></select></div>
        <div><label>Value Mode</label><select id="new_eff_mode"><option value="flat">flat</option><option value="multiplier">multiplier</option><option value="per_item">per_item</option></select></div>
      </div>
      <div class="row">
        <div><label>Value</label><input id="new_eff_value" type="number" step="0.01" value="0" /></div>
        <div><label>Scale Source</label><select id="new_eff_source"><option value="none">none</option><option value="commodity_qty">commodity_qty</option></select></div>
      </div>
      <div class="row">
        <div><label>Scale Key (commodity name)</label><select id="new_eff_key"></select></div>
        <div><label>Scale Factor</label><input id="new_eff_factor" type="number" step="0.01" value="0" /></div>
      </div>
      <div class="row">
        <div><label>Cap (0=none)</label><input id="new_eff_cap" type="number" step="0.01" value="0" /></div>
        <div><button id="addEffBtn" style="margin-top:25px;">+ Add Effect</button></div>
      </div>
    </div>
  </div>

  <script>
    const PERK_ID = Number({{ perk_id|tojson }});
    const URL_AUTH_TOKEN = new URLSearchParams(window.location.search).get("token");
    let commodityNames = [];
    let commodityTags = [];
    function el(id){ return document.getElementById(id); }
    function esc(text) {
      return String(text).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
    }
    function withAuthToken(url) {
      if (!URL_AUTH_TOKEN) return url;
      const sep = url.includes("?") ? "&" : "?";
      return `${url}${sep}token=${encodeURIComponent(URL_AUTH_TOKEN)}`;
    }
    function wireBackLink() {
      const back = el("backLink");
      if (back) {
        const tab = String(new URLSearchParams(window.location.search).get("tab") || localStorage.getItem("dashboard_tab") || "companies");
        const sep = "/".includes("?") ? "&" : "?";
        back.href = withAuthToken(`/${sep}tab=${encodeURIComponent(tab)}`);
      }
    }
    function commoditySelectOptions(selectedName) {
      const selected = String(selectedName || "");
      const names = [...commodityNames];
      if (selected && !names.some((n) => n.toLowerCase() === selected.toLowerCase())) {
        names.push(selected);
      }
      names.sort((a, b) => a.localeCompare(b));
      if (!names.length) return '<option value="">(No commodities)</option>';
      return names.map((name) => {
        const isSel = String(name) === selected ? " selected" : "";
        return `<option value="${esc(name)}"${isSel}>${esc(name)}</option>`;
      }).join("");
    }
    function scaleKeySelectOptions(selectedName) {
      return commoditySelectOptions(selectedName);
    }
    function requirementKeyOptions(reqType, selectedName) {
      const selected = String(selectedName || "");
      const rawType = String(reqType || "commodity_qty");
      const fromType = rawType === "any_single_commodities_qty" ? "any_single_commodity_qty" : rawType;
      const values = fromType === "tag_qty"
        ? [...commodityTags]
        : (fromType === "any_single_commodity_qty" ? ["*"] : [...commodityNames]);
      if (selected && !values.some((n) => n.toLowerCase() === selected.toLowerCase())) {
        values.push(selected);
      }
      values.sort((a, b) => a.localeCompare(b));
      if (!values.length) return '<option value="">(None)</option>';
      return values.map((v) => `<option value="${esc(v)}"${String(v) === selected ? " selected" : ""}>${esc(v)}</option>`).join("");
    }
    async function loadCommodityNames() {
      const res = await fetch(withAuthToken("/api/commodities"), { cache: "no-store" });
      if (!res.ok) return;
      const data = await res.json();
      const rows = Array.isArray(data.commodities) ? data.commodities : [];
      commodityNames = rows
        .map((r) => String(r.name || "").trim())
        .filter((n) => n.length > 0);
      commodityTags = Array.from(new Set(
        rows
          .flatMap((r) => Array.isArray(r.tags) ? r.tags : [])
          .map((t) => String(t || "").trim())
          .filter((t) => t.length > 0)
      ));
      const select = el("new_req_commodity");
      if (select) {
        const current = String(select.value || "");
        const reqType = String(el("new_req_type")?.value || "commodity_qty");
        select.innerHTML = requirementKeyOptions(reqType, current);
      }
      const effSelect = el("new_eff_key");
      if (effSelect) {
        const current = String(effSelect.value || "");
        effSelect.innerHTML = scaleKeySelectOptions(current);
      }
    }
    async function load() {
      await loadCommodityNames();
      const res = await fetch(withAuthToken(`/api/perk/${encodeURIComponent(PERK_ID)}`), { cache: "no-store" });
      if (!res.ok) {
        el("msg").textContent = "Perk not found.";
        return;
      }
      const data = await res.json();
      const p = data.perk || {};
      el("name").value = p.name || "";
      el("description").value = p.description || "";
      el("enabled").value = Number(p.enabled || 0);
      el("priority").value = Number(p.priority || 100);
      el("stack_mode").value = p.stack_mode || "add";
      el("max_stacks").value = Number(p.max_stacks || 1);
      renderRequirements(Array.isArray(data.requirements) ? data.requirements : []);
      renderEffects(Array.isArray(data.effects) ? data.effects : []);
      const newSelect = el("new_req_commodity");
      if (newSelect && !newSelect.value && commodityNames.length) {
        newSelect.value = commodityNames[0];
      }
      const newEffSelect = el("new_eff_key");
      if (newEffSelect && !newEffSelect.value && commodityNames.length) {
        newEffSelect.value = commodityNames[0];
      }
    }
    function renderRequirements(rows) {
      const tbody = el("reqRows");
      if (!rows.length) {
        tbody.innerHTML = '<tr><td colspan="7" class="muted">No requirements yet.</td></tr>';
        return;
      }
      tbody.innerHTML = rows.map((r) => {
        const reqTypeRaw = String(r.req_type || "commodity_qty");
        const reqTypeNorm = reqTypeRaw === "any_single_commodities_qty" ? "any_single_commodity_qty" : reqTypeRaw;
        return `<tr data-req-id="${esc(String(r.id))}">
        <td class="mono">${esc(String(r.id))}</td>
        <td><input data-req-group="${esc(String(r.id))}" type="number" step="1" value="${esc(String(r.group_id || 1))}" /></td>
        <td><select data-req-type="${esc(String(r.id))}"><option value="commodity_qty"${reqTypeNorm === "commodity_qty" ? " selected" : ""}>commodity_qty</option><option value="tag_qty"${reqTypeNorm === "tag_qty" ? " selected" : ""}>tag_qty</option><option value="any_single_commodity_qty"${reqTypeNorm === "any_single_commodity_qty" ? " selected" : ""}>any_single_commodity_qty</option></select></td>
        <td><select data-req-commodity="${esc(String(r.id))}">${requirementKeyOptions(reqTypeNorm, String(r.commodity_name || ""))}</select></td>
        <td><input data-req-operator="${esc(String(r.id))}" value="${esc(String(r.operator || ">="))}" /></td>
        <td><input data-req-value="${esc(String(r.id))}" type="number" step="1" min="0" value="${esc(String(Number(r.value || 1).toFixed(0)))}" /></td>
        <td><button data-req-save="${esc(String(r.id))}">Save</button> <button data-req-del="${esc(String(r.id))}" style="background:#7f1d1d;border-color:#ef4444;color:#fee2e2;">Delete</button></td>
      </tr>`;
      }).join("");
      document.querySelectorAll("select[data-req-type]").forEach((sel) => {
        sel.addEventListener("change", () => {
          const reqId = sel.getAttribute("data-req-type");
          if (!reqId) return;
          const keySel = document.querySelector(`select[data-req-commodity="${CSS.escape(reqId)}"]`);
          if (!keySel) return;
          const current = String(keySel.value || "");
          keySel.innerHTML = requirementKeyOptions(String(sel.value || "commodity_qty"), current);
        });
      });
      document.querySelectorAll("button[data-req-save]").forEach((btn) => {
        btn.addEventListener("click", () => updateRequirement(btn.getAttribute("data-req-save")));
      });
      document.querySelectorAll("button[data-req-del]").forEach((btn) => {
        btn.addEventListener("click", () => deleteRequirement(btn.getAttribute("data-req-del")));
      });
    }
    function renderEffects(rows) {
      const tbody = el("effectRows");
      if (!rows.length) {
        tbody.innerHTML = '<tr><td colspan="9" class="muted">No effects yet.</td></tr>';
        return;
      }
      tbody.innerHTML = rows.map((r) => `<tr data-eff-id="${esc(String(r.id))}">
        <td class="mono">${esc(String(r.id))}</td>
        <td><input data-eff-target="${esc(String(r.id))}" value="${esc(String(r.target_stat || "income"))}" /></td>
        <td><input data-eff-mode="${esc(String(r.id))}" value="${esc(String(r.value_mode || "flat"))}" /></td>
        <td><input data-eff-value="${esc(String(r.id))}" type="number" step="0.01" value="${esc(String(r.value || 0))}" /></td>
        <td><input data-eff-source="${esc(String(r.id))}" value="${esc(String(r.scale_source || "none"))}" /></td>
        <td><select data-eff-key="${esc(String(r.id))}">${scaleKeySelectOptions(String(r.scale_key || ""))}</select></td>
        <td><input data-eff-factor="${esc(String(r.id))}" type="number" step="0.01" value="${esc(String(r.scale_factor || 0))}" /></td>
        <td><input data-eff-cap="${esc(String(r.id))}" type="number" step="0.01" value="${esc(String(r.cap || 0))}" /></td>
        <td><button data-eff-save="${esc(String(r.id))}">Save</button> <button data-eff-del="${esc(String(r.id))}" style="background:#7f1d1d;border-color:#ef4444;color:#fee2e2;">Delete</button></td>
      </tr>`).join("");
      document.querySelectorAll("button[data-eff-save]").forEach((btn) => {
        btn.addEventListener("click", () => updateEffect(btn.getAttribute("data-eff-save")));
      });
      document.querySelectorAll("button[data-eff-del]").forEach((btn) => {
        btn.addEventListener("click", () => deleteEffect(btn.getAttribute("data-eff-del")));
      });
    }
    async function savePerk() {
      const payload = {
        name: el("name").value.trim(),
        description: el("description").value,
        enabled: Number(el("enabled").value),
        priority: Number(el("priority").value),
        stack_mode: el("stack_mode").value,
        max_stacks: Number(el("max_stacks").value),
      };
      const res = await fetch(withAuthToken(`/api/perk/${encodeURIComponent(PERK_ID)}/update`), {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
      });
      if (!res.ok) {
        const err = await res.json().catch(() => ({ error: "Save failed" }));
        el("msg").textContent = err.error || "Save failed.";
        return;
      }
      el("msg").textContent = "Perk saved.";
      await load();
    }
    async function deletePerk() {
      if (!window.confirm("Delete this perk?")) return;
      const res = await fetch(withAuthToken(`/api/perk/${encodeURIComponent(PERK_ID)}`), { method: "DELETE" });
      if (!res.ok) {
        const err = await res.json().catch(() => ({ error: "Delete failed" }));
        el("msg").textContent = err.error || "Delete failed.";
        return;
      }
      window.location.href = withAuthToken("/");
    }
    async function addRequirement() {
      const payload = {
        group_id: Number(el("new_req_group").value),
        req_type: el("new_req_type").value,
        commodity_name: el("new_req_commodity").value.trim(),
        operator: el("new_req_operator").value,
        value: Number(el("new_req_value").value),
      };
      const res = await fetch(withAuthToken(`/api/perk/${encodeURIComponent(PERK_ID)}/requirements`), {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
      });
      if (!res.ok) {
        const err = await res.json().catch(() => ({ error: "Add failed" }));
        el("msg").textContent = err.error || "Add requirement failed.";
        return;
      }
      await load();
    }
    async function updateRequirement(reqId) {
      if (!reqId) return;
      const payload = {
        group_id: Number(document.querySelector(`input[data-req-group="${CSS.escape(reqId)}"]`).value),
        req_type: document.querySelector(`select[data-req-type="${CSS.escape(reqId)}"]`).value,
        commodity_name: document.querySelector(`select[data-req-commodity="${CSS.escape(reqId)}"]`).value,
        operator: document.querySelector(`input[data-req-operator="${CSS.escape(reqId)}"]`).value,
        value: Number(document.querySelector(`input[data-req-value="${CSS.escape(reqId)}"]`).value),
      };
      const res = await fetch(withAuthToken(`/api/perk/${encodeURIComponent(PERK_ID)}/requirements/${encodeURIComponent(reqId)}/update`), {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
      });
      if (!res.ok) {
        const err = await res.json().catch(() => ({ error: "Update failed" }));
        el("msg").textContent = err.error || "Update requirement failed.";
        return;
      }
      await load();
    }
    async function deleteRequirement(reqId) {
      if (!reqId || !window.confirm("Delete this requirement?")) return;
      const res = await fetch(withAuthToken(`/api/perk/${encodeURIComponent(PERK_ID)}/requirements/${encodeURIComponent(reqId)}`), { method: "DELETE" });
      if (!res.ok) {
        const err = await res.json().catch(() => ({ error: "Delete failed" }));
        el("msg").textContent = err.error || "Delete requirement failed.";
        return;
      }
      await load();
    }
    async function addEffect() {
      const payload = {
        target_stat: el("new_eff_target").value,
        value_mode: el("new_eff_mode").value,
        value: Number(el("new_eff_value").value),
        scale_source: el("new_eff_source").value,
        scale_key: el("new_eff_key").value.trim(),
        scale_factor: Number(el("new_eff_factor").value),
        cap: Number(el("new_eff_cap").value),
      };
      const res = await fetch(withAuthToken(`/api/perk/${encodeURIComponent(PERK_ID)}/effects`), {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
      });
      if (!res.ok) {
        const err = await res.json().catch(() => ({ error: "Add failed" }));
        el("msg").textContent = err.error || "Add effect failed.";
        return;
      }
      await load();
    }
    async function updateEffect(effectId) {
      if (!effectId) return;
      const payload = {
        target_stat: document.querySelector(`input[data-eff-target="${CSS.escape(effectId)}"]`).value,
        value_mode: document.querySelector(`input[data-eff-mode="${CSS.escape(effectId)}"]`).value,
        value: Number(document.querySelector(`input[data-eff-value="${CSS.escape(effectId)}"]`).value),
        scale_source: document.querySelector(`input[data-eff-source="${CSS.escape(effectId)}"]`).value,
        scale_key: document.querySelector(`select[data-eff-key="${CSS.escape(effectId)}"]`).value,
        scale_factor: Number(document.querySelector(`input[data-eff-factor="${CSS.escape(effectId)}"]`).value),
        cap: Number(document.querySelector(`input[data-eff-cap="${CSS.escape(effectId)}"]`).value),
      };
      const res = await fetch(withAuthToken(`/api/perk/${encodeURIComponent(PERK_ID)}/effects/${encodeURIComponent(effectId)}/update`), {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
      });
      if (!res.ok) {
        const err = await res.json().catch(() => ({ error: "Update failed" }));
        el("msg").textContent = err.error || "Update effect failed.";
        return;
      }
      await load();
    }
    async function deleteEffect(effectId) {
      if (!effectId || !window.confirm("Delete this effect?")) return;
      const res = await fetch(withAuthToken(`/api/perk/${encodeURIComponent(PERK_ID)}/effects/${encodeURIComponent(effectId)}`), { method: "DELETE" });
      if (!res.ok) {
        const err = await res.json().catch(() => ({ error: "Delete failed" }));
        el("msg").textContent = err.error || "Delete effect failed.";
        return;
      }
      await load();
    }
    el("savePerkBtn").addEventListener("click", savePerk);
    el("deletePerkBtn").addEventListener("click", deletePerk);
    el("addReqBtn").addEventListener("click", addRequirement);
    el("addEffBtn").addEventListener("click", addEffect);
    const newReqType = el("new_req_type");
    if (newReqType) {
      newReqType.addEventListener("change", () => {
        const sel = el("new_req_commodity");
        if (!sel) return;
        sel.innerHTML = requirementKeyOptions(String(newReqType.value || "commodity_qty"), String(sel.value || ""));
      });
    }
    wireBackLink();
    load();
  </script>
</body>
</html>
