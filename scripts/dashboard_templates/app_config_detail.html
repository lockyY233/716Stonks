<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>{{ config_name }} · App Config</title>
  <style>
    :root { --bg:#0f172a; --line:#1f2937; --text:#e5e7eb; --muted:#94a3b8; --btn:#334155; --btnH:#475569; }
    body { margin:0; background:var(--bg); color:var(--text); font-family:ui-sans-serif, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; }
    .wrap { max-width: 920px; margin: 20px auto; padding: 0 14px; }
    .card { background: linear-gradient(180deg,#0b1220,#0a101c); border: 1px solid var(--line); border-radius: 12px; padding: 12px; }
    .top { display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; }
    .title { font-size:1.2rem; font-weight:700; }
    label { display:block; font-size:.82rem; color:var(--muted); margin-bottom:4px; }
    input, textarea { width:100%; padding:8px; border-radius:8px; border:1px solid #334155; background:#0b1323; color:var(--text); }
    textarea { min-height: 80px; resize: vertical; }
    button { padding:9px 12px; border:1px solid #334155; border-radius:8px; background:var(--btn); color:var(--text); cursor:pointer; margin-top: 10px; }
    button:hover { background: var(--btnH); }
    .muted { color:var(--muted); font-size:.85rem; margin-top:8px; }
    a { color:#7dd3fc; text-decoration:none; font-size:.9rem; }
    @media (max-width: 760px) {
      .top { flex-direction: column; align-items: flex-start; gap: 6px; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="top">
        <div class="title">App Config · {{ config_name }}</div>
        <a id="backLink" href="/">Back to Dashboard</a>
      </div>
      <label>Name (read-only)</label>
      <input id="name" readonly />
      <label style="margin-top:8px;">Type (read-only)</label>
      <input id="type" readonly />
      <label style="margin-top:8px;">Default (read-only)</label>
      <input id="default" readonly />
      <label style="margin-top:8px;">Description (read-only)</label>
      <textarea id="description" readonly></textarea>
      <label style="margin-top:8px;">Value</label>
      <input id="value" />
      <button id="saveBtn">Save</button>
      <div id="msg" class="muted"></div>
    </div>
  </div>
  <script>
    const CONFIG_NAME = {{ config_name|tojson }};
    const URL_AUTH_TOKEN = new URLSearchParams(window.location.search).get("token");
    function el(id){ return document.getElementById(id); }
    function withAuthToken(url) {
      if (!URL_AUTH_TOKEN) return url;
      const sep = url.includes("?") ? "&" : "?";
      return `${url}${sep}token=${encodeURIComponent(URL_AUTH_TOKEN)}`;
    }
    function wireBackLink() {
      const back = el("backLink");
      if (back) {
        const tab = String(new URLSearchParams(window.location.search).get("tab") || localStorage.getItem("dashboard_tab") || "companies");
        const sep = "/".includes("?") ? "&" : "?";
        back.href = withAuthToken(`/${sep}tab=${encodeURIComponent(tab)}`);
      }
    }
    async function load() {
      const res = await fetch(withAuthToken(`/api/app-config/${encodeURIComponent(CONFIG_NAME)}`), { cache: "no-store" });
      if (!res.ok) return;
      const data = await res.json();
      const c = data.config;
      el("name").value = c.name;
      el("type").value = c.type || "";
      el("default").value = String(c.default);
      el("description").value = c.description || "";
      el("value").value = String(c.value);
    }
    async function save() {
      const res = await fetch(withAuthToken(`/api/app-config/${encodeURIComponent(CONFIG_NAME)}/update`), {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ value: el("value").value }),
      });
      if (res.ok) {
        el("msg").textContent = "Saved.";
      } else {
        const err = await res.json().catch(()=>({error:"Failed"}));
        el("msg").textContent = err.error || "Save failed.";
      }
      await load();
    }
    el("saveBtn").addEventListener("click", save);
    wireBackLink();
    load();
  </script>
</body>
</html>
