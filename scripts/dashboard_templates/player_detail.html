<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Player {{ user_id }}</title>
  <style>
    :root { --bg:#0f172a; --line:#1f2937; --text:#e5e7eb; --muted:#94a3b8; --btn:#334155; --btnH:#475569; }
    body { margin:0; background:var(--bg); color:var(--text); font-family:ui-sans-serif, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; }
    .wrap { max-width: 920px; margin: 20px auto; padding: 0 14px; }
    .card { background: linear-gradient(180deg,#0b1220,#0a101c); border: 1px solid var(--line); border-radius: 12px; padding: 12px; }
    .top { display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; }
    .title { font-size:1.2rem; font-weight:700; }
    .row { display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:8px; }
    .row3 { display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px; margin-bottom:8px; }
    label { display:block; font-size:.82rem; color:var(--muted); margin-bottom:4px; }
    input, select { width:100%; padding:8px; border-radius:8px; border:1px solid #334155; background:#0b1323; color:var(--text); }
    button { padding:9px 12px; border:1px solid #334155; border-radius:8px; background:var(--btn); color:var(--text); cursor:pointer; }
    button:hover { background: var(--btnH); }
    .muted { color:var(--muted); font-size:.85rem; }
    a { color:#7dd3fc; text-decoration:none; font-size:.9rem; }
    .inventory-card { margin-top: 12px; border-top: 1px solid var(--line); padding-top: 12px; }
    .inventory-head { display:flex; justify-content:space-between; align-items:center; margin-bottom:8px; gap:8px; flex-wrap:wrap; }
    .inventory-grid { display:grid; grid-template-columns: 1fr auto auto; gap:8px; align-items:center; }
    .qty-input { max-width: 110px; }
    .small-btn { padding:7px 10px; }
    .history-card { margin-top: 12px; border-top: 1px solid var(--line); padding-top: 12px; }
    .history-table-wrap { overflow-x: auto; }
    .history-table { width: 100%; border-collapse: collapse; }
    .history-table th, .history-table td { border-bottom: 1px solid #1f2937; padding: 8px 6px; text-align: left; font-size: .9rem; white-space: nowrap; }
    .history-table th { color: var(--muted); font-size: .82rem; }
    .delta-pos { color: #22c55e; font-weight: 700; }
    .delta-neg { color: #ef4444; font-weight: 700; }
    .delta-zero { color: var(--muted); font-weight: 700; }
    @media (max-width: 760px) {
      .row { grid-template-columns: 1fr; }
      .row3 { grid-template-columns: 1fr; }
      .top { flex-direction: column; align-items: flex-start; gap: 6px; }
      .inventory-grid { grid-template-columns: 1fr; }
      .qty-input { max-width: unset; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="top">
        <div class="title">Player · {{ user_id }}</div>
        <a id="backLink" href="/">Back to Dashboard</a>
      </div>
      <div class="row">
        <div><label>Display Name (read-only)</label><input id="display_name" readonly /></div>
        <div><label>Joined At (read-only)</label><input id="joined_at" readonly /></div>
      </div>
      <div class="row">
        <div><label>Bank</label><input id="bank" type="number" step="0.01" /></div>
        <div><label>Networth</label><input id="networth" type="number" step="0.01" /></div>
      </div>
      <div class="row">
        <div><label>Owe</label><input id="owe" type="number" step="0.01" /></div>
        <div><label>Rank</label><input id="rank" /></div>
      </div>
      <div class="row">
        <div><label>Current Trade Limit (read-only)</label><input id="trade_limit_status" readonly /></div>
        <div><label>Trade Usage Action</label><button id="resetTradeBtn" type="button" style="background:#7f1d1d;border-color:#ef4444;color:#fee2e2;">Reset Trade Usage</button></div>
      </div>
      <button id="saveBtn">Save</button>
      <div id="msg" class="muted" style="margin-top:8px;"></div>

      <div class="inventory-card">
        <div class="inventory-head">
          <div class="title" style="font-size:1rem;">Commodities</div>
          <div class="muted" id="inventorySummary">Loading...</div>
        </div>
        <div class="row3">
          <div>
            <label>Add/Remove Commodity</label>
            <select id="invCommodity"></select>
          </div>
          <div>
            <label>Delta (can be negative)</label>
            <input id="invDelta" type="number" step="1" value="1" />
          </div>
          <div style="display:flex; align-items:flex-end;">
            <button id="applyDeltaBtn" class="small-btn" type="button">Apply Delta</button>
          </div>
        </div>
        <div id="inventoryRows" class="inventory-grid"></div>
      </div>

      <div class="history-card">
        <div class="inventory-head">
          <div class="title" style="font-size:1rem;">Bank Balance History</div>
          <div class="muted" id="historySummary">Loading...</div>
        </div>
        <div class="history-table-wrap">
          <table class="history-table">
            <thead>
              <tr>
                <th>Time</th>
                <th>Action</th>
                <th>Target</th>
                <th>Delta</th>
                <th>Details</th>
              </tr>
            </thead>
            <tbody id="historyRows">
              <tr><td colspan="5" class="muted">Loading...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
  <script>
    const USER_ID = {{ user_id|tojson }};
    let INVENTORY = [];
    let AVAILABLE = [];
    let BANK_HISTORY = [];
    function el(id){ return document.getElementById(id); }
    const URL_AUTH_TOKEN = new URLSearchParams(window.location.search).get("token");
    function withAuthToken(url) {
      if (!URL_AUTH_TOKEN) return url;
      const sep = url.includes("?") ? "&" : "?";
      return `${url}${sep}token=${encodeURIComponent(URL_AUTH_TOKEN)}`;
    }
    function wireBackLink() {
      const back = el("backLink");
      if (back) {
        const tab = String(new URLSearchParams(window.location.search).get("tab") || localStorage.getItem("dashboard_tab") || "companies");
        const sep = "/".includes("?") ? "&" : "?";
        back.href = withAuthToken(`/${sep}tab=${encodeURIComponent(tab)}`);
      }
    }
    async function load() {
      const [playerRes, invRes, histRes] = await Promise.all([
        fetch(withAuthToken(`/api/player/${encodeURIComponent(USER_ID)}`), { cache: "no-store" }),
        fetch(withAuthToken(`/api/player/${encodeURIComponent(USER_ID)}/commodities`), { cache: "no-store" }),
        fetch(withAuthToken(`/api/player/${encodeURIComponent(USER_ID)}/bank-history`), { cache: "no-store" }),
      ]);
      if (!playerRes.ok) return;
      const data = await playerRes.json();
      const p = data.player;
      el("display_name").value = p.display_name || "";
      el("joined_at").value = p.joined_at || "";
      el("bank").value = Number(p.bank).toFixed(2);
      el("networth").value = Number(p.networth).toFixed(2);
      el("owe").value = Number(p.owe || 0).toFixed(2);
      el("rank").value = p.rank || "";
      if (p.trade_limit_enabled) {
        el("trade_limit_status").value =
          `${Number(p.trade_limit_remaining || 0)}/${Number(p.trade_limit_limit || 0)} shares remaining `
          + `(${Number(p.trade_limit_used || 0)} used, ${Number(p.trade_limit_window_minutes || 0).toFixed(2)} min window)`;
      } else {
        el("trade_limit_status").value = "Disabled";
      }
      if (invRes.ok) {
        const invData = await invRes.json();
        INVENTORY = Array.isArray(invData.inventory) ? invData.inventory : [];
        AVAILABLE = Array.isArray(invData.available) ? invData.available : [];
        renderInventory();
      }
      if (histRes.ok) {
        const histData = await histRes.json();
        BANK_HISTORY = Array.isArray(histData.history) ? histData.history : [];
        renderBankHistory();
      }
    }

    function fmtHistoryDate(value) {
      if (!value) return "-";
      const d = new Date(value);
      if (Number.isNaN(d.getTime())) return String(value);
      return d.toLocaleString("en-US", {
        year: "numeric",
        month: "2-digit",
        day: "2-digit",
        hour: "2-digit",
        minute: "2-digit",
        second: "2-digit",
        hour12: false,
      });
    }

    function fmtDelta(delta) {
      const n = Number(delta || 0);
      const sign = n > 0 ? "+" : "";
      return `${sign}$${n.toFixed(2)}`;
    }

    function esc(value) {
      return String(value ?? "")
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;");
    }

    function renderBankHistory() {
      const rows = el("historyRows");
      const summary = el("historySummary");
      summary.textContent = `${BANK_HISTORY.length} recent entries`;
      if (!BANK_HISTORY.length) {
        rows.innerHTML = '<tr><td colspan="5" class="muted">No balance history yet.</td></tr>';
        return;
      }
      rows.innerHTML = BANK_HISTORY.map((r) => {
        const delta = Number(r.delta || 0);
        const klass = delta > 0 ? "delta-pos" : (delta < 0 ? "delta-neg" : "delta-zero");
        const action = String(r.action_type || "-").toUpperCase();
        const targetType = String(r.target_type || "").trim();
        const targetSymbol = String(r.target_symbol || "").trim();
        const target = [targetType, targetSymbol].filter(Boolean).join(" · ") || "-";
        const details = String(r.details || "-");
        return `
          <tr>
            <td>${esc(fmtHistoryDate(r.created_at))}</td>
            <td>${esc(action)}</td>
            <td>${esc(target)}</td>
            <td class="${klass}">${fmtDelta(delta)}</td>
            <td title="${esc(details)}">${esc(details)}</td>
          </tr>
        `;
      }).join("");
    }

    function renderInventory() {
      const rows = el("inventoryRows");
      const summary = el("inventorySummary");
      const select = el("invCommodity");
      const totalQty = INVENTORY.reduce((n, r) => n + Number(r.quantity || 0), 0);
      summary.textContent = `${totalQty} total units`;

      const names = AVAILABLE.length ? AVAILABLE : INVENTORY.map((r) => String(r.name || ""));
      select.innerHTML = names.map((n) => {
        const key = encodeURIComponent(String(n));
        return `<option value="${key}">${n}</option>`;
      }).join("");
      if (!select.value && names.length) select.value = encodeURIComponent(String(names[0]));

      if (!INVENTORY.length) {
        rows.innerHTML = `<div class="muted">No commodities owned.</div>`;
        return;
      }
      rows.innerHTML = INVENTORY.map((r) => {
        const name = String(r.name || "");
        const key = encodeURIComponent(name);
        const qty = Number(r.quantity || 0);
        return `
          <div><strong>${name}</strong></div>
          <input class="qty-input" data-qty-key="${key}" type="number" step="1" min="0" value="${qty}" />
          <button class="small-btn" data-save-qty="${key}" type="button">Set Qty</button>
        `;
      }).join("");

      document.querySelectorAll("button[data-save-qty]").forEach((btn) => {
        btn.addEventListener("click", async () => {
          const key = btn.getAttribute("data-save-qty");
          const input = document.querySelector(`input[data-qty-key="${CSS.escape(key)}"]`);
          if (!input) return;
          const qty = Number(input.value);
          const name = decodeURIComponent(String(key || ""));
          await setCommodityQty(name, qty);
        });
      });
    }

    async function setCommodityQty(name, quantity) {
      const res = await fetch(withAuthToken(`/api/player/${encodeURIComponent(USER_ID)}/commodities/set`), {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ commodity_name: name, quantity }),
      });
      if (res.ok) {
        el("msg").textContent = `Updated ${name}.`;
      } else {
        const err = await res.json().catch(()=>({error:"Failed"}));
        el("msg").textContent = err.error || "Update failed.";
      }
      await load();
    }

    async function applyDelta() {
      const key = String(el("invCommodity").value || "").trim();
      const name = decodeURIComponent(key);
      const delta = Number(el("invDelta").value || 0);
      if (!name || !Number.isFinite(delta) || delta === 0) {
        el("msg").textContent = "Pick a commodity and non-zero delta.";
        return;
      }
      const cur = INVENTORY.find((r) => String(r.name) === name);
      const nextQty = Math.max(0, Number(cur?.quantity || 0) + Math.trunc(delta));
      await setCommodityQty(name, nextQty);
    }
    async function save() {
      const payload = {
        bank: Number(el("bank").value),
        networth: Number(el("networth").value),
        owe: Number(el("owe").value),
        rank: el("rank").value,
      };
      const res = await fetch(withAuthToken(`/api/player/${encodeURIComponent(USER_ID)}/update`), {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
      });
      if (res.ok) {
        el("msg").textContent = "Saved.";
      } else {
        const err = await res.json().catch(()=>({error:"Failed"}));
        el("msg").textContent = err.error || "Save failed.";
      }
      await load();
    }
    async function resetTradeUsage() {
      const btn = el("resetTradeBtn");
      const original = btn.textContent;
      btn.disabled = true;
      btn.textContent = "Resetting...";
      try {
        const res = await fetch(withAuthToken(`/api/player/${encodeURIComponent(USER_ID)}/reset-trade-usage`), {
          method: "POST",
        });
        if (res.ok) {
          el("msg").textContent = "Trade usage reset.";
        } else {
          const err = await res.json().catch(()=>({error:"Failed"}));
          el("msg").textContent = err.error || "Reset failed.";
        }
      } finally {
        btn.disabled = false;
        btn.textContent = original;
      }
      await load();
    }
    el("saveBtn").addEventListener("click", save);
    el("resetTradeBtn").addEventListener("click", resetTradeUsage);
    el("applyDeltaBtn").addEventListener("click", applyDelta);
    wireBackLink();
    load();
  </script>
</body>
</html>
